stages:
  - build
  - deploy
    #script: ng build && npx scully
#   script: pwd && ls -latr && npm install && /usr/bin/npm run prerender

build_npm:
  stage: build
  script:
    - npm install
    - ng build --configuration production --build-optimizer
    - npm run scully -- --scanRoutes --noPrompt
#    - ng add @scullyio/init
#    - ng build --prod
#    - npm run build:ssr
#    - pwd && ls
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - ./dist
#      - ./node_modules.tar.gz

deploy_landing_page:
  stage: deploy
  script:
    - ssh procland@192.168.10.131 'echo "procland" | [ -d /home/procland/dist ] && rm -rf /home/procland/dist || :'
    - scp -o stricthostkeychecking=no -r ./dist procland@192.168.10.131:/home/procland/
#    - ssh procland@192.168.7.48 'echo "procland" | [ "$( sudo -S /usr/bin/pm2 status main | grep online )" ] && sudo /usr/bin/pm2 stop main || :'
#    - ssh procland@192.168.7.48 'echo "procland" | [ -d /var/www/pmi/landing/dist ] && sudo -S rm -rf /var/www/pmi/landing/dist'
#    - ssh procland@192.168.7.48 'echo "procland" | [ -d /var/www/pmi/landing/node_modules ] && sudo -S rm -rf /var/www/pmi/landing/node_modules'
#    - ssh procland@192.168.7.48 'echo "procland" | [ -d /tmp/dist ] && sudo -S rm -rf /tmp/dist || :'
#    - ssh procland@192.168.7.48 'echo "procland" | [ -d /tmp/node_modules.tar.gz ] && sudo -S rm -rf /tmp/node_modules.tar.gz || :'    
#    - scp -o stricthostkeychecking=no -r ./dist procland@192.168.7.48:/tmp/
#    - scp -o stricthostkeychecking=no -r ./node_modules.tar.gz procland@192.168.7.48:/tmp/    
#    - ssh procland@192.168.7.48 'echo "procland" | [ -d /tmp/dist ] && sudo -S cp -ar /tmp/dist /var/www/pmi/landing/'
#    - ssh procland@192.168.7.48 'echo "procland" | [ -d /tmp/node_modules.tar.gz ] && sudo -S tar -xvzf /tmp/node_modules.tar.gz -C /var/www/pmi/landing/'    
#    - ssh procland@192.168.7.48 'echo "procland" | sudo -S /usr/bin/pm2 start main'
  environment: 
    name: PROCUREMENT24ORE_LANDINGPAGE
    url: 192.168.10.131:4000    
#    url: 192.168.7.48:4000
  only:
    - master

after_script:
  - echo "End CI"